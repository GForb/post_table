version 13
class TableBody {
    *Variable properties
    string varname
    string over_variable
	string over_groups = "overall"
    string overall
    string stats = "summary"
    
	double summary_cols_first = 0
	double completeness_cols = 0
    double completeness_brackets = 0
    double cols_by_over_variable = 0 // if this is 1 then table is sum1 comp1 sum2 comp2 
    double n_cols

    
    
}, inherit(Table)

prog .new
    if "`0'" != "" {
        .set_options `0'
    }
    .count_cols
end

prog .set_options 
    syntax, [statistics(string) over(string) overall(passthru) over_groups(passthru)  cols_by_over_variable]
    .set_over_variable_and_groups `over', `overall' `over_groups'
    if "`completeness_brackets'" != "" .completeness_brackets = 1
    if "`completeness_cols'" != "" .completeness_cols = 1
    if "`summary_cols_first'" != "" .summary_cols_first = 1
    if "`cols_by_over_variable'" != "" .cols_by_over_variable = 1
    if "`statistics'" != "" .stats = "`statistics'"
end

prog .count_cols
    .Super.count_cols
    if "`.over_variable'" == "" {
        .n_cols = `.n_cols' + wordcount("`.stats'")
    }
    else {
        .n_cols = `.n_cols' + wordcount("`.over_groups'")*wordcount("`.stats'")
    }
end

prog .set_over_variable_and_groups
    syntax [varlist(default=none)],  [overall(string) over_groups(numlist)]
    .over_variable = "`varlist'"
    .overall = "`overall'"
    .set_over_groups "`over_groups'"
end

prog .set_over_groups
    args over_groups
    if "`over_groups'" == "" & "`.over_variable'" != ""  {
        qui levelsof `.over_variable', local(over_groups)
    }
    if "`.overall'" == "first" local over_groups overall `over_groups'
    if "`.overall'" == "last" local over_groups  `over_groups' overall
    
    if "`.over_variable'" == "" {
        local over_groups = "overall"
    }
    .over_groups = "`over_groups'"
end

prog .set_stats
    .stats = "summary"
    if `.completeness_brackets' ==1 .stats = "summary_comp_brackets"
    if `.completeness_cols' == 1 {
        if `.summary_cols_first' ==1 .stats = "summary completeness_summary"
        if `.summary_cols_first' ==0 .stats = "completeness_summary summary" 
    }
end


prog .get_body
    if `.cols_by_over_variable' == 0 {
        class exit `"`.get_body_by_over_var'"'

    }
    else {
        class exit `"`.get_body_by_summary'"'
    }
    
end

prog .get_body_by_over_var
    foreach over_val in `.over_groups' {
        get_stats_over, over_value(`over_val')
        foreach stat in `.stats' {
            local body `body' ("`.`.varname'.`stat''")
        }
    }
    class exit `"`body'"'
end

prog .get_body_by_summary
    foreach stat in `.stats' {
        foreach over_val in `.over_groups' {
            get_stats_over, over_value(`over_val')
            local body `body' ("`.`.varname'.`stat''")
        }
            
    }
    class exit `"`body'"'
end

prog get_stats_over
    syntax, over_value(string)
    if "`over_value'" != "overall" {
        preserve
        keep if `.over_variable' == `over_value'
    } 
    .`.varname'.calculate_stats
end

